/* Author: Drew Chase */
class Authentication{constructor(){this.admin=!1,this.inactivityTimer,this.resetInactivityTimer(),this.admin=this.isLoggedIn(),$("body").on("mousemove",()=>this.resetInactivityTimer()),$("body").on("keypress",()=>this.resetInactivityTimer()),$("body").on("click",()=>this.resetInactivityTimer()),$("body").on("touchstart",()=>this.resetInactivityTimer()),$("body").on("touchmove",()=>this.resetInactivityTimer()),$("body").on("touchend",()=>this.resetInactivityTimer()),$(".logout").on("click",()=>this.logout())}async loginWithToken(){let t=await $.ajax({url:"/api/auth.php",method:"POST"});return this.handleAuthData(t)||console.error(`Error logging in with token: ${t.error}`),t}async login(t,i){$("#login-error").html("");let e=await $.ajax({url:"/api/auth.php",method:"POST",data:{username:t,password:i}});return this.handleAuthData(e)||console.error(`Error logging in: ${e.error}`),e}logout(){document.cookie="auth-token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;",window.location.reload()}isLoggedIn(){return document.cookie.split(";").forEach(async t=>{if("auth-token"==t.split("=")[0].trim()){return(await this.loginWithToken()).success}}),!1}resetInactivityTimer(){null!=this.inactivityTimer&&clearTimeout(this.inactivityTimer),this.admin&&(this.inactivityTimer=setTimeout(()=>{this.logout(),closePopup(),displayAdminLogin()},3e5))}handleAuthData(t){if(t.success){let i=new Date(Date.now()+6048e5);document.cookie=`auth-token=${t.user.token}; expires=${i.toUTCString()}; path=/;SameSite=Strict;`,this.admin=!0,this.resetInactivityTimer(),$(this).trigger("logged-in")}return t.success}}