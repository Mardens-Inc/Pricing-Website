/* Author: Drew Chase */
const listTypes={directory:0,location:1,voice:2};class Database{constructor(){this.total_items=0,this.data={},this.options={},this.listData={},this.columns=[],this.resetURLParameters(),this.limit=localStorage.getItem("limit"),this.page=localStorage.getItem("page"),this.sort=localStorage.getItem("sort"),this.ascending=localStorage.getItem("asc"),this.keyword=localStorage.getItem("q"),this.list=localStorage.getItem("id"),window.location.pathname.startsWith("/list")?(this.list=window.location.pathname.split("/")[2],this.load(this.limit,this.page,this.sort,this.ascending,this.keyword,this.list)):(this.list="",this.updateURLParameters(),this.loadList(""))}async search(t){return await this.load(this.limit,0,this.sort,this.ascending,t,this.list)}async loadList(t){return await this.load(this.limit,0,"id",!0,"",t)}async sortList(t,i){return await this.load(this.limit,0,t,i,this.keyword,this.list)}async load(t=10,i=0,s="id",e=!0,a="",o=""){if(this.list=o,this.sort=s,this.ascending=e,this.page=i,this.limit=t,this.keyword=a,null!=a&&(a=a.replace(/^0+/,"").trim()),this.updateURLParameters(),""!=this.list){this.listData=await this.loadListData();try{this.options=JSON.parse(this.listData.options)}catch{this.options={}}}else this.options={};const r=new URL(`/api/location${""==o?"s":""}.php`,window.location.origin);return r.searchParams.set("limit",t),r.searchParams.set("page",i),r.searchParams.set("sort",s),e&&r.searchParams.set("asc",""),""!=a&&r.searchParams.set("query",a),""!=o&&r.searchParams.set("id",o),await $.ajax({url:r.href,type:"GET",success:t=>t.error?(console.error(t.error),void alert(t.error)):(this.total_items=t.items.length,this.data=t,$(this).trigger("loaded",[{type:""==o?listTypes.directory:listTypes.location,data:t}]),t),error:t=>{return console.error(`Error loading data: ${JSON.stringify(t)}}`),this.resetURLParameters(),this.updateURLParameters(),confirm("An error occurred while loading the data. Would you like to reload?")&&window.location.reload(),t}})}async loadOptions(){const t=await this.loadListData();return JSON.parse(t.options)}async loadListData(){if(""===this.list)return console.error("Cannot get options for the main list."),null;const t={url:`/api/locations.php?id=${this.list}&action=single`,type:"GET",success:t=>t,error:t=>(console.error(t),t)};return await $.ajax(t)}async resetURLParameters(){this.list="",this.sort="id",this.ascending=!0,this.page=0,this.limit=10}updateURLParameters(){localStorage.setItem("limit",this.limit),localStorage.setItem("page",this.page),localStorage.setItem("sort",this.sort),localStorage.setItem("asc",this.ascending),localStorage.setItem("q",this.keyword),localStorage.setItem("id",this.list),""!=this.list?window.history.pushState("","",`/list/${this.list}`):window.history.pushState("","","/")}async loadColumns(){return await $.ajax({url:`/api/location.php?action=columns&id=${""==this.list?"locations":this.list}`,type:"GET",success:t=>t.columns,error:t=>(console.error(t),t)})}async loadColumnDisplayNames(){let t=(await this.loadColumns()).columns,i=[];return Array.from(t).forEach(t=>{i.push(t.replace("_"," "))}),{columns:t,displayNames:i}}async generateTable(){let t=await this.loadColumnDisplayNames(),i=t.displayNames;t=t.columns,this.columns=t;let s=$("<table><thead></thead><tbody></tbody></table>"),e=this.data;if(null==e||0==e.length)return s.find("tbody").append("<p>No data found!</p>"),s;s.find("thead").append("<tr></tr>");for(let e=0;e<t.length;e++){let a=i[e],o=t[e];if("options"==o||"image"==o)continue;"id"==o&&(a="");let r=$(`<th class="location-${o}" sort="${o}">${a}</th>`);o==this.sort&&r.attr("direction",this.ascending?"asc":"desc"),"date"==o&&0==this.options["show-date"]||s.find("thead tr").append(r)}return""!=this.list&&s.find("thead tr").append($("<th></th>")),Array.from(e.items).forEach(i=>{let e=new Date(i.post_date),a="";if(null!=i.image&&""!=i.image&&(a=`<img src="/assets/images/locations/${i.image}">`),""==this.list){let t=$(`\n                <tr id="${i.id}">\n                    <td class="location-icon">${a}</td>\n                    <td class="location-name">${i.name}</td>\n                    <td class="location-address">${i.location}</td>\n                    <td class="location-po">${i.po}</td>\n                    <td class="location-date">${e.toLocaleString()}</td>\n                </tr>\n                `);t.on("click",()=>this.load(this.limit,0,"id",!0,"",i.id)),s.find("tbody").append(t)}else{let e="";for(let s=0;s<t.length;s++){let a=t[s],o=i[a];null==o&&(o=""),("date"!=a||"Invalid Date"!=(o=new Date(o).toLocaleString())&&0!=this.options["show-date"])&&(e+=`<td class="location-${a}">${o}</td>`)}e+=`\n                <td class="show-options">\n                    ${1==this.options.print?'<button class="print"><i class="fa-solid fa-print"></i></button>':""}\n                    <button class="more"><i class="fa-solid fa-ellipsis-vertical"></i></button>\n                </td>`,(e=$(`<tr id="${i.id}">${e}</tr>`)).find(".show-options button.more").on("click",()=>{openListItemOptions(e)}),e.find(".show-options button.print").on("click",()=>{printElement=e,print()}),e.on("contextmenu",t=>{t.preventDefault(),openListItemOptions(e)}),s.append(e)}}),s}async editList(t,i,s,e,a){const o=`/api/locations.php?id=${this.list}&action=edit`,r={method:"POST",data:{name:t,location:i,po:s,image:e,options:JSON.stringify(a)},success:function(t){if(t.error)return console.error(`Error editing pricing list: ${t.error}`),alert(`Error editing pricing list: ${t.error}`),void closePopup();database.loadList(database.list),closePopup()},error:function(t,i,s){console.error(`Error editing pricing list: ${s}`),alert(`Error editing pricing list: ${s}`),closePopup()}};$.ajax(o,r)}async editListItem(t){const i=`/api/location.php?id=${this.list}&action=edit`,s={method:"POST",data:t,success:function(t){if(t.error)return console.error(`Error editing pricing list: ${t.error}`),alert(`Error editing pricing list: ${t.error}`),void closePopup();database.loadList(database.list),closePopup()},error:function(t,i,s){console.error(`Error editing pricing list: ${s}`),alert(`Error editing pricing list: ${s}`),closePopup()}};await $.ajax(i,s)}async deleteItem(t){const i=`/api/location.php?id=${this.list}&item=${t}`;console.log(i);const s={method:"DELETE",success:function(t){if(t.error)return console.error(`Error deleting pricing list: ${t.error}`),alert(`Error deleting pricing list: ${t.error}`),void closePopup();database.loadList(database.list),closePopup()},error:function(t,i,s){console.error(`Error deleting pricing list: ${s}`),alert(`Error deleting pricing list: ${s}`),closePopup()}};await $.ajax(i,s)}async deleteAllRows(){if(""==this.list)return;closePopup(),openPopup("loading-popup");const t=`/api/location.php?id=${this.list}`;await $.ajax({url:t,method:"DELETE",success:()=>{this.loadList(this.list)},error:t=>{alert(`Error deleting all rows: ${t.error}`),closePopup()}}),closePopup()}async deleteList(){""!=this.list&&await $.ajax(`/api/locations.php?id=${this.list}`,{method:"DELETE",success:t=>{if(t.error)return console.error(`Error deleting pricing list: ${t.error}`),void alert(`Error deleting pricing list: ${t.error}`);this.loadList(""),closePopup()},error:(t,i,s)=>{console.error(`Error deleting pricing list: ${s}`),alert(`Error deleting pricing list: ${s}`)}})}openVoicePopup(){let t=new Voice(/[^0-9]/g);t.unsupported||(openPopup("voice-search-popup"),$("#voice-search-popup.popup").on("close",()=>{t.stop(),this.search("")}),t.start(),$(t).on("result",async(i,s)=>{$(".voice-notification > p").text(s),closePopup();let e=(await this.search(s)).items,a=e[0][database.options["voice-description-column"]],o=e[0][database.options["voice-price-column"]];o=o.replace("$",""),null!=e&&(0==e.length?t.speak("No results found!"):1==e.length?(t.speak("Found 1 result"),t.speak(`${a} is $${o}`)):(t.speak(`Found ${e.length} results`),t.speak(`The first result is ${a} at $${o}`)))}),$(t).on("interim",(t,i)=>{$(".voice-notification > p").text(i),$(".voice-notification").addClass("active"),$(".voice-notification").addClass("results")}),$(t).on("end",()=>{$(".voice-notification p").text("Listening..."),$(".voice-notification").removeClass("results"),t.shouldListen&&t.start()}))}}class Pagination{constructor(t){this.total_items=Number.parseInt(t.data.total_results),this.current_page=t.data.page,this.items_per_page=t.data.max_count,this.last_page=0,this.pages=this.items_per_page>0?Math.ceil(this.total_items/this.items_per_page):0,this.database=t}getPaginationHTML(){let t=$("<div class='pagination row center horizontal vertical fill'></div>");if(this.pages=Math.ceil(this.total_items/this.items_per_page),this.last_page=this.pages,1>this.current_page&&(this.current_page=1),1>=this.pages)return t;if(this.pages>0){let i=$('<div class="page-item"><button class="page-link secondary">Previous</button></div>');i.on("click",()=>this.previous()),t.prepend(i)}for(let i=1;i<=this.pages;i++){let s=$(`<div class="page-item ${i==this.current_page?"active":""}"><button class="page-link ${this.page==i-1?"":"secondary"}">${i}</button></div>`);s.on("click",()=>{this.page=i-1,this.load()}),t.append(s)}let i=$('<div class="page-item"><button class="page-link secondary">Next</button></div>');return i.on("click",()=>this.next()),t.append(i),t}previous(){this.current_page<this.last_page-1&&(this.current_page++,this.database.load({page:this.current_page,limit:this.items_per_page}),$(this).trigger("previous"))}next(){this.current_page>0&&(this.current_page--,this.database.load({page:this.current_page,limit:this.items_per_page}),$(this).trigger("next"))}}