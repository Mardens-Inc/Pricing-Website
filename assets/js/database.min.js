/* Author: Drew Chase */
const listTypes={directory:0,location:1,voice:2};class Database{constructor(){this.total_items=0,this.data={},this.options={},this.listData={},this.columns=[],this.resetURLParameters()}async search(t){return await this.load(this.limit,0,this.sort,this.ascending,t,this.list)}async loadList(t){return await this.load(this.limit,0,"id",!0,"",t)}async sortList(t,i){return await this.load(this.limit,0,t,i,this.keyword,this.list)}async load(t=10,i=0,s="id",e=!0,a="",r=""){if(this.list=r,this.sort=s,this.ascending=e,this.page=i,this.limit=t,this.keyword=a,a=a.replace(/^0+/,"").trim(),this.updateURLParameters(),""!=this.list){this.listData=await this.loadListData();try{this.options=JSON.parse(this.listData.options)}catch{this.options={}}}else this.options={};let o=`/api/location${""==r?"s":""}.php?limit=${t}&page=${i}&sort=${s}${e?"&asc":""}${""==a?"":"&query="+a}${""==r?"":"&id="+r}`;const n=new URL(`/api/location${""==r?"s":""}`,window.location.origin);return n.searchParams.set("limit",t),n.searchParams.set("page",i),n.searchParams.set("sort",s),e&&n.searchParams.set("asc",""),""!=a&&n.searchParams.set("q",a),""!=r&&n.searchParams.set("id",r),console.log(n.href),console.log(o),await $.ajax({url:n.href,type:"GET",success:t=>t.error?(console.error(t.error),void alert(t.error)):(this.total_items=t.items.length,this.data=t,$(this).trigger("loaded",[{type:""==r?listTypes.directory:listTypes.location,data:t}]),t),error:t=>{return console.error(`Error loading data: ${JSON.stringify(t)}}`),this.resetURLParameters(),this.updateURLParameters(),confirm("An error occurred while loading the data. Would you like to reload?")&&window.location.reload(),t}})}async loadOptions(){const t=await this.loadListData();return JSON.parse(t.options)}async loadListData(){if(""===this.list)return console.error("Cannot get options for the main list."),null;const t={url:`/api/locations.php?&id=${this.list}&action=single`,type:"GET",success:t=>t,error:t=>(console.error(t),t)};return await $.ajax(t)}async resetURLParameters(){this.list="",this.sort="id",this.ascending=!0,this.page=0,this.limit=10}updateURLParameters(){const t=new URL("/",window.location.origin);t.searchParams.set("limit",this.limit),t.searchParams.set("page",this.page),t.searchParams.set("sort",this.sort),this.ascending&&t.searchParams.set("asc",""),""!=this.keyword&&t.searchParams.set("q",this.keyword),""!=this.list&&t.searchParams.set("id",this.list),window.history.pushState("","",t.href)}async loadColumns(){return await $.ajax({url:`/api/location.php?action=columns&id=${""==this.list?"locations":this.list}`,type:"GET",success:t=>t.columns,error:t=>(console.error(t),t)})}async loadColumnDisplayNames(){let t=(await this.loadColumns()).columns,i=[];return Array.from(t).forEach(t=>{i.push(t.replace("_"," "))}),{columns:t,displayNames:i}}async generateTable(){let t=await this.loadColumnDisplayNames(),i=t.displayNames;t=t.columns,this.columns=t;let s=$("<table><thead></thead><tbody></tbody></table>"),e=this.data;if(null==e||0==e.length)return s.find("tbody").append("<p>No data found!</p>"),s;s.find("thead").append("<tr></tr>");for(let e=0;e<t.length;e++){let a=i[e],r=t[e];if("options"==r||"image"==r)continue;"id"==r&&(a="");let o=$(`<th class="location-${r}" sort="${r}">${a}</th>`);r==this.sort&&o.attr("direction",this.ascending?"asc":"desc"),s.find("thead tr").append(o)}return Array.from(e.items).forEach(i=>{let e=new Date(i.post_date),a="";if(null!=i.image&&""!=i.image&&(a=`<img src="/assets/images/locations/${i.image}">`),""==this.list){let t=$(`\n                <tr id="${i.id}">\n                    <td class="location-icon">${a}</td>\n                    <td class="location-name">${i.name}</td>\n                    <td class="location-address">${i.location}</td>\n                    <td class="location-po">${i.po}</td>\n                    <td class="location-date">${e.toLocaleDateString("en-us",{hour:"2-digit",minute:"2-digit",weekday:"long",year:"numeric",month:"short",day:"numeric"})}</td>\n                </tr>\n                `);t.on("click",()=>this.load(this.limit,0,"id",!0,"",i.id)),s.find("tbody").append(t)}else{let e="";for(let s=0;s<t.length;s++){let a=t[s],r=i[a];null==r&&(r=""),e+=`<td class="location-${a}">${r}</td>`}(e=$(`<tr id="${i.id}">${e}</tr>`)).on("click",()=>{0==selectedElements.length?openListItemOptions(e):selectElement(i.id)}),e.on("contextmenu",t=>{t.preventDefault(),openListItemOptions(e)}),s.append(e)}}),s}async editList(t,i,s,e,a){const r=`/api/locations.php?id=${this.list}&action=edit`,o={method:"POST",data:{name:t,location:i,po:s,image:e,options:JSON.stringify(a)},success:function(t){if(t.error)return console.error(`Error editing pricing list: ${t.error}`),alert(`Error editing pricing list: ${t.error}`),void closePopup();database.loadList(database.list),closePopup()},error:function(t,i,s){console.error(`Error editing pricing list: ${s}`),alert(`Error editing pricing list: ${s}`),closePopup()}};$.ajax(r,o)}async editListItem(t){const i=`/api/location.php?id=${this.list}&action=edit`,s={method:"POST",data:t,success:function(t){if(t.error)return console.error(`Error editing pricing list: ${t.error}`),alert(`Error editing pricing list: ${t.error}`),void closePopup();database.loadList(database.list),closePopup()},error:function(t,i,s){console.error(`Error editing pricing list: ${s}`),alert(`Error editing pricing list: ${s}`),closePopup()}};await $.ajax(i,s)}async deleteItem(t){const i=`/api/location.php?id=${this.list}&item=${t}`;console.log(i);const s={method:"DELETE",success:function(t){if(t.error)return console.error(`Error deleting pricing list: ${t.error}`),alert(`Error deleting pricing list: ${t.error}`),void closePopup();database.loadList(database.list),closePopup()},error:function(t,i,s){console.error(`Error deleting pricing list: ${s}`),alert(`Error deleting pricing list: ${s}`),closePopup()}};await $.ajax(i,s)}async deleteAllRows(){if(""==this.list)return;closePopup(),openPopup("loading-popup");const t=`/api/location.php?id=${this.list}`;await $.ajax({url:t,method:"DELETE",success:()=>{this.loadList(this.list)},error:t=>{alert(`Error deleting all rows: ${t.error}`),closePopup()}}),closePopup()}async deleteList(){""!=this.list&&await $.ajax(`/api/locations.php?id=${this.list}`,{method:"DELETE",success:t=>{if(t.error)return console.error(`Error deleting pricing list: ${t.error}`),void alert(`Error deleting pricing list: ${t.error}`);this.loadList(""),closePopup()},error:(t,i,s)=>{console.error(`Error deleting pricing list: ${s}`),alert(`Error deleting pricing list: ${s}`)}})}openVoicePopup(){let t=new Voice(/[^0-9]/g);t.unsupported||(openPopup("voice-search-popup"),$("#voice-search-popup.popup").on("close",()=>{t.stop(),this.search("")}),t.start(),$(t).on("result",async(i,s)=>{$(".voice-notification > p").text(s),closePopup();let e=(await this.search(s)).items,a=e[0][database.options["voice-description-column"]],r=e[0][database.options["voice-price-column"]];r=r.replace("$",""),null!=e&&(0==e.length?t.speak("No results found!"):1==e.length?(t.speak("Found 1 result"),t.speak(`${a} is $${r}`)):(t.speak(`Found ${e.length} results`),t.speak(`The first result is ${a} at $${r}`)))}),$(t).on("interim",(t,i)=>{$(".voice-notification > p").text(i),$(".voice-notification").addClass("active"),$(".voice-notification").addClass("results")}),$(t).on("end",()=>{$(".voice-notification p").text("Listening..."),$(".voice-notification").removeClass("results"),t.shouldListen&&t.start()}))}}class Pagination{constructor(t){this.total_items=Number.parseInt(t.data.total_results),this.current_page=t.data.page,this.items_per_page=t.data.max_count,this.last_page=0,this.pages=this.items_per_page>0?Math.ceil(this.total_items/this.items_per_page):0,this.database=t}getPaginationHTML(){let t=$("<div class='pagination row center horizontal vertical fill'></div>");if(this.pages=Math.ceil(this.total_items/this.items_per_page),this.last_page=this.pages,1>this.current_page&&(this.current_page=1),1>=this.pages)return t;if(this.pages>0){let i=$('<div class="page-item"><button class="page-link secondary">Previous</button></div>');i.on("click",()=>this.previous()),t.prepend(i)}for(let i=1;i<=this.pages;i++){let s=$(`<div class="page-item ${i==this.current_page?"active":""}"><button class="page-link ${this.page==i-1?"":"secondary"}">${i}</button></div>`);s.on("click",()=>{this.page=i-1,this.load()}),t.append(s)}let i=$('<div class="page-item"><button class="page-link secondary">Next</button></div>');return i.on("click",()=>this.next()),t.append(i),t}previous(){this.current_page<this.last_page-1&&(this.current_page++,this.database.load({page:this.current_page,limit:this.items_per_page}),$(this).trigger("previous"))}next(){this.current_page>0&&(this.current_page--,this.database.load({page:this.current_page,limit:this.items_per_page}),$(this).trigger("next"))}}